---
title: "Module 4 Code Along: Hotel bookings"
# author: 
#   - Nicholas Duran, Derek Powell^[Authored modifications to original code]
#   - Mine Ã‡etinkaya-Rundel^[Original author of exercise]
# output:
#   html_document:
#     # theme: united
#     theme: yeti
#     highlight: pygments
output:
  html_document
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r load-pkg, message = FALSE}
library(tidyverse)

```

```{r}
# From TidyTuesday: https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-11/readme.md
hotels <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv")
```

Let's visualize different aspects of hotel bookings on a few different timescales.

## Plot adr by month

First let's plot average adr by month of the year.

```{r adr-by-month}
hotels %>%
  group_by(hotel, arrival_date_month) %>%   # group by hotel type and arrival month
  summarise(mean_adr = mean(adr)) %>%       # calculate mean adr for each group
  ggplot(aes(
    x = arrival_date_month,                 # x-axis = arrival_date_month
    y = mean_adr,                           # y-axis = mean_adr calculated above
    group = hotel,                          # group lines by hotel type
    color = hotel)                          # and color by hotel type
    ) +
  geom_line() 
```

## Fix ordering of the months (as factors)

We will want to use a function from the **forcats** package, see <https://forcats.tidyverse.org/reference/index.html> for inspiration and help.

```{r adr-by-month-ordered}
hotels %>%
  mutate(arrival_date_month = fct_relevel(arrival_date_month, month.name)) %>% 
  group_by(hotel, arrival_date_month) %>%   # group by hotel type and arrival month
  summarise(mean_adr = mean(adr)) %>%       # calculate mean adr for each group
  ggplot(aes(
    x = arrival_date_month,                 # x-axis = arrival_date_month
    y = mean_adr,                           # y-axis = mean_adr calculated above
    group = hotel,                          # group lines by hotel type
    color = hotel)                          # and color by hotel type
    ) +
  geom_line() 
```

## Make it pretty

```{r adr-by-month-pretty}
hotels %>%
  mutate(arrival_date_month = fct_relevel(arrival_date_month, month.name)) %>%  # show to be careful w/ month.name[12:1]
  mutate(arrival_date_month = factor(arrival_date_month, labels = month.abb)) %>%
  group_by(hotel, arrival_date_month) %>%   # group by hotel type and arrival month
  summarise(mean_adr = mean(adr)) %>%       # calculate mean adr for each group
  ggplot(aes(
    x = arrival_date_month,                 # x-axis = arrival_date_month
    y = mean_adr,                           # y-axis = mean_adr calculated above
    group = hotel,                          # group lines by hotel type
    color = hotel)                          # and color by hotel type
    ) +
  geom_line() +                             # use lines to represent data
  theme_minimal() +                         # use a minimal theme
  labs(
    x = "Arrival month",                 # customize labels
    y = "Mean ADR (average daily rate)",
    title = "Comparison of resort and city hotel prices across months",
    subtitle = "Resort hotel prices soar in the summer while ciry hotel prices remain relatively constant throughout the year",
    color = "Hotel type"
    ) +
  scale_y_continuous(labels=scales::dollar_format())
```

**A final touch:** Change the y-axis label so the values are shown with dollar signs, e.g. \$80 instead of 80.
We can use a function from the **scales** package, see <https://scales.r-lib.org/reference/index.html>.

## Plot cancellations by day of week

When do people cancel their plans more? Are travelers arriving different days more likely to cancel their plans?

uh oh, no day of the week variable! we can use **lubridate** for this

```{r cancel-by-day-of-week}
library(lubridate)

days_of_week <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")

hotels %>%
  mutate(
    arrival_date_str = paste(arrival_date_month, arrival_date_day_of_month, arrival_date_year),
    arrival_date_str = parse_date_time(arrival_date_str, "mdY"),
    arrival_date = as_date(arrival_date_str)
  ) %>% 
  mutate(
    arrival_date_weekday = wday(arrival_date),
    arrival_date_weekday = factor(arrival_date_weekday, labels=days_of_week),
    # arrival_date_weekday = ordered(arrival_date_weekday, levels = days_of_week[c(2:7, 1)])
    ) %>% 
  group_by(hotel, arrival_date_weekday) %>% 
  summarize(mean_adr = mean(adr), prop_canceled = sum(is_canceled)/n()) %>%       # calculate mean adr for each group
  ggplot(aes(
    x = arrival_date_weekday,                 # x-axis = arrival_date_month
    y = prop_canceled,                           # y-axis = mean_adr calculated above
    group = hotel,                          # group lines by hotel type
    color = hotel)                          # and color by hotel type
    ) +
  geom_line() +                             # use lines to represent data
  theme_minimal() +                         # use a minimal theme
  labs(
    x = "Arrival day",                 # customize labels
    y = "Prop. Cancellations",
    title = "Comparison of resort and city hotel cancellations across days of week",
    subtitle = "Cancellations peak on different days for the different reservation types",
    color = "Hotel type"
    )
```


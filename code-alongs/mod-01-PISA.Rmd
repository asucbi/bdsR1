---
title: "PISA + Welcome + hi!"
author:
  - Nicholas Duran
output:
  html_document:
    # theme: united
    theme: yeti
    highlight: pygments
# output:
#   github_document
date: "`r format(Sys.time(), '%d %B, %Y')`"
# output:
#   html_document:
#     toc: yes
#     toc_float: yes
---

## Introduction

How do 15-year-old students in various countries score on the same math test? How do the scores differ between females and males? How have the scores changed over time? Answering these questions (at a high level) is the focus of this analysis.

### Packages

We will use the **tidyverse**  for data wrangling and visualization, and the **DT** package for interactive display of tabular output, and the **learningtower** package for the data.

```{r load-packages, warning=FALSE, message=FALSE}
library(tidyverse)
library(DT)
library(learningtower)
```

### Data

The data we're using comes from the **learningtower** package. The package allows easy access to a subset of variables from a massive dataset put together by the Programme for International Student Assessment (PISA). Every three years, PISA administers standardized tests in areas of reading, mathematics, and scientific literacy with 600,000+ 15-year-old students across 80 countries. The over-arching goal is to assess the extent to which students worldwide have acquired some of the knowledge and skills that are essential for full participation in society. 

In the chunks below we load in two of three datasets in **learningtower** and modify the data by joining the data frames to help you get started with the analysis.

```{r}
data(student_subset_2018)
data(countrycode)
```

```{r}
student_scores <- student_subset_2018 %>%
  inner_join(countrycode, by = "country") 
```

```{r, echo=FALSE}
# View(student_scores)
# glimpse(student_scores)
```

## Student scores on math for 2018

Let's create a data visualization that displays how students performed on the math assessment for seven countries, breaking the scores down by gender^[note: that we call this variable gender and not sex as this term was used in the OECD PISA database]. We can easily change which countries are being plotted by changing which countries the code below filters for. Note that the country name should be spelled and capitalized exactly the same way as it appears in the data. See the [Appendix](#appendix) for a list of the countries in the data.

```{r, plot-math-scores, fig.width=10, fig.height=8, message=FALSE}
# prepare new data frame, 'student_scores,' to be used in plot
student_scores %>% 
  group_by(country, gender) %>% 
  dplyr::filter(country %in% c("UKR", "QAT", "USA" , "JPN", 
                               "MEX", "GBR",  "SGP")) %>% 
  dplyr::mutate(country_name = factor(
    country_name,
    levels = c("Singapore", "Ukraine", "Japan",
                "United States", "United Kingdom", "Mexico", "Qatar"))) %>%
  
  # now use 'ggplot' function to plot the prepared data frame
  ggplot(aes(x = math,
             y = country_name,
             fill = gender)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#FF7F0EFF", "#1F77B4FF")) +
  theme_classic() +
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=18,face="bold"),
        legend.text = element_text(size = 21),
        legend.title = element_text(size = 21)
        ) +
  labs(x = "Math score", 
       y = "")
```

## Change over time

In this figure, we can see how the average math score for each country changed from 2012 to 2018. 

```{r, prepare-time-plot, eval = TRUE, echo = FALSE, message = FALSE}
# prepare new data frame, 'student_data_2012_2018,' to be used in plot
student_data_2012_2018 <- load_student(c(2012, 2018))
student_data_2012_2018 %>% 
  group_by(country, year) %>%  
  dplyr::filter(country %in% c("UKR", "QAT", "USA" , "JPN", 
                               "MEX", "GBR",  "SGP")) %>%   
  dplyr::summarise(avg_math = mean(math, na.rm = TRUE)) %>%  
  left_join(countrycode, by = "country") %>% 
  dplyr::select(country_name, year, avg_math) %>% 
  ungroup() %>% 
  dplyr::mutate(
    year = year %>% as.character %>% as.integer, 
    label_x_pos = ifelse(year == 2012, 2012 - 2, 2018 + 1),
    label = ifelse(
      year == 2012,
      paste0(country_name, ", ", round(avg_math)),
      round(avg_math))) %>%
  
  # now use 'ggplot' function to plot the prepared data frame  
  ggplot(aes(x = year, 
             y = avg_math,
             label = label,
             color = country_name,
             group = country_name)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept=2012,
             linetype="dashed",
             linewidth=0.1) +
  geom_vline(xintercept=2018,
             linetype="dashed",
             linewidth=0.1) + 
  geom_text(aes(x = label_x_pos),
            position = position_nudge(y = 0)) +
  scale_x_continuous(breaks = c(2012, 2018),
                     limits = c(2008, 2020)) +
  scale_colour_manual(values = c("#1F77B4FF", "#FF7F0EFF", "#2CA02CFF", "#D62728FF", "#9467BDFF", "#8C564BFF", "#7F7F7FFF")) +
  labs(x = "",
       y = "Average math score") +
  theme_classic() +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title=element_text(size=18,face="bold"),
        axis.text=element_text(size=14),
        legend.position = "none")
  
```

## References

1. Kevin Wang (2021). [learningtower](https://CRAN.R-project.org/package=learningtower): learningtower: OECD PISA Datasets from 2000-2018 in an Easy-to-Use Format. R package version 1.0.0.
2. Organisation for Economic Co-operation and Development. (2019), PISA 2018 Assessment and Analytical Framework, PISA, OECD Publishing, Paris. Retrieved from the OECD [website](https://doi.org/10.1787/b25efab8-en). 
3. Much of the analysis has been modeled on the examples presented in the [learningtower package vignette](https://kevinwang09.github.io/learningtower/articles/learningtower_student.html).

## Appendix {#appendix}

Below is a list of countries in the dataset:

```{r list-countries, echo=FALSE, message=FALSE}
student_scores %>% 
  select(country_name) %>%
  arrange(country_name) %>% 
  distinct() %>%
  datatable()
```

---
title: "Lab 04 - Lead exposure and personality Part 2"
# knit: (function(inputFile, encoding) {
#     rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs/labs/")
#   })
params: 
    SHOW_SOLS: FALSE # if i wanted to give solutions, could toggle back on. 
    TOGGLE: TRUE
---

```{r setup, include=FALSE}
source('assets/setup.R')

# :::red : use for pre-lab activity instructions
# :::lo : use for outlining the learning objectives
# :::green : use for tips on how to complete the task
# :::yellow : use for additional information on how to use R that does not directly have anything to do with the assignment tasks
# :::frame : use when want to set some additional instructions/code/examples apart from the assignment task when explaining something about how to use R

# :::blue : same color as question box background. Not sure how much this needs to be used. 
# :::statbox : looks a lot like yellow

```


More and more, epidemiologists are uncovering the alarmingly detrimental effects of environmental pollution for human health and well-being. As has long been known, childhood lead exposure has particularly damaging and lifelong consequences, with even low levels stunting intellectual development. The ancient Romans famously lined their aquaducts with lead, which some have speculated may have hastened the empire's downfall by contaminating their drinking water ([Nriagu,1983 ](https://dl.tufts.edu/concern/pdfs/6395wk23b)). More recently, atmospheric lead exposure from leaded gasoline was substantial across the developed world. Fortunately, in the U.S. the Clean Air Act of 1970 began transitioning away from the use of leaded gasoline, though it wasn't outright banned in the U.S. until 1996. Some epidemiologists and economists believe that reduced lead exposure (especially during childhood) is at least partly responsible for reductions in crime since the 80s and 90s ([Higney et al., 2022](https://www-sciencedirect-com.ezproxy1.lib.asu.edu/science/article/pii/S0166046222000667)).

However, the benefits of environmental reforms are often not felt evenly. Leaded gasoline was used in the developing world long after it was banned in most Western nations---the last stockpiles were only finally used up by Algeria in July of 2021 ([NPR](https://www.npr.org/2021/08/30/1031429212/the-world-has-finally-stopped-using-leaded-gasoline-algeria-used-the-last-stockp))!  And even in the U.S., many communities are still exposed to too much lead and other environmental pollutants, especially communities of color like Flint, MI.

The idea that an environmental pollutant could harm health is worrying. The idea that it could stunt one's intellect, or even impair one's decision-making is perhaps unsettling on another level. But could lead exposure do something even deeper than all that---could it change your personality?

In this lab we'll explore data from a recent [paper](https://psyarxiv.com/nxdca/) by Schwaba and colleagues (2022) published in the _Proceedings of the National Academy of Sciences_ that explores this question.

:::lo
**LEARNING OBJECTIVES**

-   Visualizing correlations
-   Visualizing spatial data
-   Joining data frames
:::

:::red
**PRE-LAB ACTIVITY**

__Recommended reading:__ ["Lead: America’s Real Criminal Element" (_Mother Jones_)](https://www.motherjones.com/environment/2016/02/lead-exposure-gasoline-crime-increase-children-health/) by Kevin Drum, a leading proponent of the "lead-crime hypothesis" (also recommended, its [wikipedia entry](https://en.wikipedia.org/wiki/Lead%E2%80%93crime_hypothesis)).

:::


# Getting started

Go to the course RStudio Cloud Workspace and locate the folder for the lab assignment, which should be named `lab-04-lead-personality`.

First, open the R Markdown document `lab-04.Rmd` and Knit it.

Make sure it compiles without errors and you can preview the output within the Viewer Pane.  

The output should also be automatically saved as an `.html` file with the same name.

## Warm up

Before we introduce the data, let's warm up with a simple exercise.

-   Update the YAML, changing the author name to your name, and **knit** the document.

## Packages

We'll use the **tidyverse** package for much of the data wrangling.

This package is already installed for you.

You can load it by running the following in your Console:

```{r load-packages, message = FALSE}
library(tidyverse)
```

## Data

We're going to work with two datasets in this lab, both of which can be found as CSV (comma separated values) files in the `data` folder of your repository.

You can read the first of these in using the following, we'll call it `survey`.

```{r load-data, message = FALSE, eval = TRUE}
# nobel <- read_csv("https://asucbi.github.io/data/nobel.csv")
survey <- read_csv("../data/eu-pers-survey.csv")
```

The variable descriptions are as follows:

| Variable Name | Description            |
|---------------|--------------------|
|   `Country`| Name of country |
|   `mean_e`| Avg. Extraversion score |
|   `sd_e`| Std. Dev. of Extraversion |
|   `mean_a`| Avg. Agreeableness score |
|   `sd_a`| Std. Dev. of Extraversion |
|   `mean_c`| Avg. Conscientiousness score |
|   `sd_c`| Std. Dev. of Conscientiousness |
|   `mean_n`| Avg. Neuroticism score |
|   `sd_n`| Std. Dev. of Neuroticism |
|   `mean_o`| Avg. Openness score |
|   `sd_o`| Std. Dev. of Openness |
|   `mean_age`| Avg. age of respondents |
|   `n`| Number of respondents |

The second dataset we will use is some country-level statistics for all European Union countries. You can read in the second dataset with the following, calling it `eudata`:

```{r}
eudata <- read_csv("../data/eu-country-data.csv")
```


# Exercises

Take turns answering the exercises.
<!-- If workign remotely through Zoom, make sure that the person taking the lead for an exercise is sharing their screen. -->

You don't have to switch at each exercise, you can find your a cadence that works for your team and stick to it.

## Get to know your data

---

`r qbegin(1)`
I didn't give you an explanation of the `eudata` variables. Look at the names of the variables in the `eudata` data. What do you think the data in each of these variables represents?
`r qend()`


`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}

# Need to watch videos and read material to see if there is a suggested way of doing this in there. Add answers here. 

```
`r solend()`


---

`r qbegin(2)`

Let's inspect our `survey` data to see if it contains responses from all EU countries. Are there any Countries missing in the `survey` dataset as compared to the `eudata` dataset?

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r echo=FALSE}
survey %>% 
  filter(!Country %in% eudata$Country)
```
`r solend()`

---
`r qbegin(3)`

What's going on here? Are we missing any observations in `survey` compared to `eudata`?

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}
# missing one, one is just mismatched
# Need to watch videos and read material to see if there is a suggested way of doing this in there. Add answers here. 
nrow(survey)
nrow(eudata)
```
`r solend()`

<!-- 🧶 ✅ ⬆️ Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.* -->

---

## Joining data frames

To investigate whether lead exposure is related to personality, we need to join these data frames into one. But, first we need to recode the `Country` variables so that they match.

We know there's some problems related to Czech Republic and Bosnia & Herzegovina, so let's inspect the `Country` variable in each dataset to see what exactly is wrong.

```{r}
eudata %>% filter(str_detect(Country, "(Czech|Bosnia)")) %>% pull(Country)
survey %>% filter(str_detect(Country, "(Czech|Bosnia)")) %>% pull(Country)
```

:::green
__NOTE:__ The code above uses something called a ["regular expression"](https://en.wikipedia.org/wiki/Regular_expression) in the `str_detect` function to check where the values of `Country` match either "Czech" or "Bosnia". Regular expressions are powerful tools for working with text, though we will keep things simple in this course.
:::


`r qbegin(4)`
Now that we know what the problem is, use the `case_when` function to recode the `Country` variable in the `eudata` data frame to match how they are written in the `survey` data.
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}
eudata <- eudata %>% 
  mutate(
    Country = case_when(
     Country=="Bosnia and Herzegovina" ~  "Bosnia & Herzegovina",
     Country== "Czech Republic" ~ "Czechia",
     TRUE ~ Country
  )
  )
```
`r solend()`

:::green
__NOTE:__ If we had a lot of countries to rename, we could also use the titular function from the `countrycode` package to rename countries according to standard naming conventions.
:::

`r qbegin(5)`
Now we are ready to join the data frames. Join them on the `Country` variable. Will it make a difference which kind of join you perform?
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}
combined <- left_join(eudata, survey, by = "Country")
```
`r solend()`


## Claim: Lead exposure affects "agreeableness"

In this paper it is argued that lead exposure is associated with lower agreeableness, so that people exposed to more lead are less agreeable. 

`r qbegin(6)`
Make a plot to examine whether there is any association between the average agreeableness score in each country and the average lead exposure.

What do you conclude?
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}
combined %>% 
  ggplot(aes(x=mean_leadexposure, y = mean_a)) +
  geom_point()
```
`r solend()`


## Exploring further: Geography

You have surely heard that "correlation is not causation" --- so we can't say whether there is any causal relationship between agreeableness and lead exposure. One reason is that an association between two variables could be _confounded_---e.g. there might be some other third variable that affects them both and that produces the association. We'll talk about this more later in the course, but for now let's briefly explore some possibilities by looking at another kind of visualization: a map.

One thing we might think could influence personality is geography. Without playing too much into broad stereotypes, there are many historical and cultural differences between people in Eastern Europe versus Western Europe. Maybe people in the East or West are more or less agreeable? Maybe they also happen to have more or less lead exposure?

The `ggplot2` package includes a function called `map_data()` that loads data for plotting maps of different parts of the world. The code below loads data with latitude and longitude points marking the boundaries of all the different nations of the world and then turns that `data.frame` object into a `tibble`.

```{r}
map_data("world") %>% 
  as_tibble()
```

If we join this with our `combined` data, we will be ready to plot a map of the variable we're interested in.

`r qbegin(7)`
Join the `combined` data with the `map_data("world")` data. Make sure to do so in a way that only keeps the countries we have data for in the `combined` dataset. You can assign this to a variable just called `d`.

```{r, eval=F}
d <- ...
```

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}
d <- map_data("world") %>% 
  right_join(combined, by = c("region"="Country"))
```
`r solend()`

:::green
Short variable names like `d` can be useful for "temporary" data that won't be used for more than one thing. We're only going to be using `d` to make our map plots, but we wouldn't use it for any other kinds of analysis, so the short and generically non-descript name can be OK here.
:::


### Map it!

Now we're ready to make our map to explore the possibility of geographic differences. The code below creates the basic map.

```{r}
ggplot(d, aes(x=long, y = lat, group=group)) + 
  geom_polygon() + 
  coord_fixed() 
```

`r qbegin(8)`
Modify the code above to plot agreeableness by country. Use the `fill` of the maps colors to plot agreeableness and use the viridis color scheme to make it look nicer with `scale_fill_viridis_c()`.


Then, do the same for lead exposure. Do you notice any patterns? Does the geographic explanation of the association seem plausible? Can you see the association between lead and agreeableness on the maps?

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r}
ggplot(d, aes(x=long, y = lat, group=group, fill = mean_leadexposure)) + 
  geom_polygon() + 
  scale_fill_viridis_c() +
  coord_fixed() 

ggplot(d, aes(x=long, y = lat, group=group, fill = mean_a)) + 
  geom_polygon() + 
  scale_fill_viridis_c() +
  coord_fixed() 
```
`r solend()`

---

Now go back through your write up to make sure you've answered all questions and all of your R chunks are properly labelled.

:::red
**SUBMITTING YOUR WORK**

Once you decide as a team that you're done with this lab, change the YAML `output` from `html_output` to `pdf_output.` Now knit the document to produce a final PDF file. Make sure all team members have access to the PDF and each person needs to upload the PDF as a Canvas assignment.   
:::

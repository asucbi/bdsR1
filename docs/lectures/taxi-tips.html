<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nick Duran">
<meta name="dcterms.date" content="2024-11-07">

<title>Prediction w/ tidyModels</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="taxi-tips_files/libs/clipboard/clipboard.min.js"></script>
<script src="taxi-tips_files/libs/quarto-html/quarto.js"></script>
<script src="taxi-tips_files/libs/quarto-html/popper.min.js"></script>
<script src="taxi-tips_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="taxi-tips_files/libs/quarto-html/anchor.min.js"></script>
<link href="taxi-tips_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="taxi-tips_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="taxi-tips_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="taxi-tips_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="taxi-tips_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#part-1-what-are-tidymodels" id="toc-part-1-what-are-tidymodels" class="nav-link active" data-scroll-target="#part-1-what-are-tidymodels">PART 1: What are tidyModels</a>
  <ul class="collapse">
  <li><a href="#machine-learning-as-a-predictive-modeling-process" id="toc-machine-learning-as-a-predictive-modeling-process" class="nav-link" data-scroll-target="#machine-learning-as-a-predictive-modeling-process">Machine learning as a predictive modeling process</a></li>
  <li><a href="#your-turn" id="toc-your-turn" class="nav-link" data-scroll-target="#your-turn">Your turn</a></li>
  <li><a href="#the-whole-game" id="toc-the-whole-game" class="nav-link" data-scroll-target="#the-whole-game">The whole game</a></li>
  </ul></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
  <ul class="collapse">
  <li><a href="#taxi-trips-in-chicago-in-2022" id="toc-taxi-trips-in-chicago-in-2022" class="nav-link" data-scroll-target="#taxi-trips-in-chicago-in-2022">Taxi trips in Chicago in 2022</a></li>
  </ul></li>
  <li><a href="#part-2-data-budget" id="toc-part-2-data-budget" class="nav-link" data-scroll-target="#part-2-data-budget">PART 2: Data Budget</a>
  <ul class="collapse">
  <li><a href="#data-splitting-and-spending" id="toc-data-splitting-and-spending" class="nav-link" data-scroll-target="#data-splitting-and-spending">Data splitting and spending</a></li>
  <li><a href="#your-turn-1" id="toc-your-turn-1" class="nav-link" data-scroll-target="#your-turn-1">Your turn</a></li>
  <li><a href="#the-initial-split" id="toc-the-initial-split" class="nav-link" data-scroll-target="#the-initial-split">The initial split</a></li>
  <li><a href="#accessing-the-data" id="toc-accessing-the-data" class="nav-link" data-scroll-target="#accessing-the-data">Accessing the data</a></li>
  <li><a href="#your-turn-2" id="toc-your-turn-2" class="nav-link" data-scroll-target="#your-turn-2">Your turn</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory data analysis</a></li>
  <li><a href="#your-turn-3" id="toc-your-turn-3" class="nav-link" data-scroll-target="#your-turn-3">Your turn</a></li>
  <li><a href="#split-smarter" id="toc-split-smarter" class="nav-link" data-scroll-target="#split-smarter">Split smarter</a></li>
  <li><a href="#your-turn-4" id="toc-your-turn-4" class="nav-link" data-scroll-target="#your-turn-4">Your turn</a></li>
  </ul></li>
  <li><a href="#part-3-fitting-a-model" id="toc-part-3-fitting-a-model" class="nav-link" data-scroll-target="#part-3-fitting-a-model">PART 3: Fitting a model</a>
  <ul class="collapse">
  <li><a href="#do-it-the-tidymodels-way" id="toc-do-it-the-tidymodels-way" class="nav-link" data-scroll-target="#do-it-the-tidymodels-way">Do it the tidymodels way</a></li>
  <li><a href="#your-turn-5" id="toc-your-turn-5" class="nav-link" data-scroll-target="#your-turn-5">Your turn</a></li>
  <li><a href="#models-well-be-using-today" id="toc-models-well-be-using-today" class="nav-link" data-scroll-target="#models-well-be-using-today">Models weâ€™ll be using today</a></li>
  <li><a href="#model-workflows" id="toc-model-workflows" class="nav-link" data-scroll-target="#model-workflows">Model workflows</a></li>
  <li><a href="#a-model-workflow" id="toc-a-model-workflow" class="nav-link" data-scroll-target="#a-model-workflow">A model workflow</a></li>
  <li><a href="#your-turn-6" id="toc-your-turn-6" class="nav-link" data-scroll-target="#your-turn-6">Your turn</a></li>
  <li><a href="#pre-processing-adding-recipes" id="toc-pre-processing-adding-recipes" class="nav-link" data-scroll-target="#pre-processing-adding-recipes">Pre-processing: Adding â€œrecipesâ€</a></li>
  <li><a href="#how-do-you-understand-your-new-tree_fit-model" id="toc-how-do-you-understand-your-new-tree_fit-model" class="nav-link" data-scroll-target="#how-do-you-understand-your-new-tree_fit-model">How do you <strong>understand</strong> your new <code>tree_fit</code> model?</a></li>
  <li><a href="#your-turn-7" id="toc-your-turn-7" class="nav-link" data-scroll-target="#your-turn-7">Your turn</a></li>
  </ul></li>
  <li><a href="#part-4-metrics-for-model-performance" id="toc-part-4-metrics-for-model-performance" class="nav-link" data-scroll-target="#part-4-metrics-for-model-performance">PART 4: Metrics for model performance</a>
  <ul class="collapse">
  <li><a href="#confusion-matrix" id="toc-confusion-matrix" class="nav-link" data-scroll-target="#confusion-matrix">Confusion matrix</a></li>
  <li><a href="#accuracy" id="toc-accuracy" class="nav-link" data-scroll-target="#accuracy">Accuracy</a></li>
  <li><a href="#sensitivity" id="toc-sensitivity" class="nav-link" data-scroll-target="#sensitivity">Sensitivity</a></li>
  <li><a href="#specificity" id="toc-specificity" class="nav-link" data-scroll-target="#specificity">Specificity</a></li>
  <li><a href="#combining-the-metrics" id="toc-combining-the-metrics" class="nav-link" data-scroll-target="#combining-the-metrics">Combining the metrics</a></li>
  <li><a href="#your-turn-8" id="toc-your-turn-8" class="nav-link" data-scroll-target="#your-turn-8">Your turn</a></li>
  <li><a href="#roc-curves" id="toc-roc-curves" class="nav-link" data-scroll-target="#roc-curves">ROC curves</a></li>
  <li><a href="#your-turn-9" id="toc-your-turn-9" class="nav-link" data-scroll-target="#your-turn-9">Your turn</a></li>
  </ul></li>
  <li><a href="#part-5-using-resampling-to-estimate-performance" id="toc-part-5-using-resampling-to-estimate-performance" class="nav-link" data-scroll-target="#part-5-using-resampling-to-estimate-performance">PART 5: Using resampling to estimate performance</a>
  <ul class="collapse">
  <li><a href="#dangers-of-overfitting" id="toc-dangers-of-overfitting" class="nav-link" data-scroll-target="#dangers-of-overfitting">âš ï¸ Dangers of Overfitting âš ï¸</a></li>
  <li><a href="#v-fold-k-fold-cross-validation" id="toc-v-fold-k-fold-cross-validation" class="nav-link" data-scroll-target="#v-fold-k-fold-cross-validation">V-fold (K-fold) Cross-validation</a></li>
  <li><a href="#your-turn-10" id="toc-your-turn-10" class="nav-link" data-scroll-target="#your-turn-10">Your turn</a></li>
  <li><a href="#lets-do-some-cross-validation" id="toc-lets-do-some-cross-validation" class="nav-link" data-scroll-target="#lets-do-some-cross-validation">Letâ€™s do some cross-validation</a></li>
  <li><a href="#fit-our-model-to-the-resamples" id="toc-fit-our-model-to-the-resamples" class="nav-link" data-scroll-target="#fit-our-model-to-the-resamples">Fit our model to the resamples!</a></li>
  <li><a href="#your-turn-11" id="toc-your-turn-11" class="nav-link" data-scroll-target="#your-turn-11">Your turn</a></li>
  <li><a href="#evaluating-model-performance" id="toc-evaluating-model-performance" class="nav-link" data-scroll-target="#evaluating-model-performance">Evaluating model performance</a></li>
  <li><a href="#your-turn-12" id="toc-your-turn-12" class="nav-link" data-scroll-target="#your-turn-12">Your turn</a></li>
  <li><a href="#what-you-would-report" id="toc-what-you-would-report" class="nav-link" data-scroll-target="#what-you-would-report">What you would report</a></li>
  <li><a href="#your-turn-13" id="toc-your-turn-13" class="nav-link" data-scroll-target="#your-turn-13">Your turn</a></li>
  <li><a href="#completing-the-whole-game" id="toc-completing-the-whole-game" class="nav-link" data-scroll-target="#completing-the-whole-game">Completing the whole game</a></li>
  </ul></li>
  <li><a href="#part-6-next-steps" id="toc-part-6-next-steps" class="nav-link" data-scroll-target="#part-6-next-steps">PART 6: Next Steps?</a>
  <ul class="collapse">
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random forest ğŸŒ³ğŸŒ²ğŸŒ´ğŸŒµğŸŒ³ğŸŒ³ğŸŒ´ğŸŒ²ğŸŒµğŸŒ´ğŸŒ³ğŸŒµ</a></li>
  <li><a href="#model-tuning" id="toc-model-tuning" class="nav-link" data-scroll-target="#model-tuning">Model tuning</a></li>
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance">Variable importance</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Prediction w/ tidyModels</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nick Duran </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 7, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<style type="text/css">
.callout-caution {
  display: none;
}
</style>
</div>
<p><img src="hexes/tidymodels.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
<section id="part-1-what-are-tidymodels" class="level1">
<h1>PART 1: What are tidyModels</h1>
<p>A modeling framework!</p>
<p><img src="img/tm-org.png" class="img-fluid"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-tm}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: true</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidymodels)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; â”€â”€ Attaching packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidymodels 1.2.0 â”€â”€</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; âœ” broom        1.0.5      âœ” rsample      1.2.1 
#&gt; âœ” dials        1.3.0      âœ” tibble       3.2.1 
#&gt; âœ” dplyr        1.1.4      âœ” tidyr        1.3.1 
#&gt; âœ” infer        1.0.7      âœ” tune         1.2.1 
#&gt; âœ” modeldata    1.4.0      âœ” workflows    1.1.4 
#&gt; âœ” parsnip      1.2.1      âœ” workflowsets 1.1.0 
#&gt; âœ” purrr        1.0.2      âœ” yardstick    1.3.1 
#&gt; âœ” recipes      1.0.10</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; â”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidymodels_conflicts() â”€â”€
#&gt; âœ– purrr::discard() masks scales::discard()
#&gt; âœ– dplyr::filter()  masks stats::filter()
#&gt; âœ– dplyr::lag()     masks stats::lag()
#&gt; âœ– recipes::step()  masks stats::step()
#&gt; â€¢ Use suppressPackageStartupMessages() to eliminate package startup messages</code></pre>
</div>
</div>
<section id="what-we-will-be-working-on-today" class="level3">
<h3 class="anchored" data-anchor-id="what-we-will-be-working-on-today">What we will be working on today</h3>
<ul>
<li>Minimal version of predictive modeling process</li>
</ul>
</section>
<section id="what-we-will-not-be-working-on-today-but-that-is-in-the-recorded-lectures" class="level3">
<h3 class="anchored" data-anchor-id="what-we-will-not-be-working-on-today-but-that-is-in-the-recorded-lectures">What we will not be working on today but that is in the recorded lectures</h3>
<ul>
<li>Feature engineering (recipes)</li>
</ul>
</section>
<section id="machine-learning-as-a-predictive-modeling-process" class="level2">
<h2 class="anchored" data-anchor-id="machine-learning-as-a-predictive-modeling-process">Machine learning as a predictive modeling process</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://imgs.xkcd.com/comics/machine_learning.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/ml_illustration.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/what_is_ml.jpg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="your-turn" class="level2">
<h2 class="anchored" data-anchor-id="your-turn">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="how-are-statistics-and-machine-learning-related-how-are-they-different" class="anchored"><em>How are statistics and machine learning related?; How are they different?</em></h3></li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Only open when you have researched your answers for these questions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>They are sometimes thought of as capturing â€œtwo cultures:â€ Model first vs.&nbsp;data first; or inference vs.&nbsp;prediction</p>
</div>
</div>
</div>
</section>
<section id="the-whole-game" class="level2">
<h2 class="anchored" data-anchor-id="the-whole-game">The whole game</h2>
<p><img src="img/whole-game-final-performance.jpg" class="img-fluid"></p>
<section id="splitting-data-aka-your-data-budget-and-building-a-decision-tree" class="level3">
<h3 class="anchored" data-anchor-id="splitting-data-aka-your-data-budget-and-building-a-decision-tree">Splitting data (aka your data budget) and building a decision tree</h3>
<p><img src="img/whole-game-transparent-model-1.jpg" class="img-fluid"></p>
</section>
<section id="cross-validation-i.e.-resampling" class="level3">
<h3 class="anchored" data-anchor-id="cross-validation-i.e.-resampling">Cross validation, i.e., resampling</h3>
<ul>
<li>Comparing multiple model types and evaluating to identify best one</li>
</ul>
<!-- ![](img/whole-game-transparent-resamples.jpg) -->
<p><img src="img/whole-game-transparent-select.jpg" class="img-fluid"> <!-- ![](img/whole-game-model-1.jpg) --></p>
<!-- ![](img/whole-game-resamples.jpg) -->
</section>
<section id="creating-a-final-model-fit-object-and-doing-a-final-test" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-final-model-fit-object-and-doing-a-final-test">Creating a final model fit object and doing a final test</h3>
<p><img src="img/whole-game-final-performance.jpg" class="img-fluid"></p>
</section>
</section>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<section id="taxi-trips-in-chicago-in-2022" class="level2">
<h2 class="anchored" data-anchor-id="taxi-trips-in-chicago-in-2022">Taxi trips in Chicago in 2022</h2>
<p><img src="img/taxi_spinning.svg" class="img-fluid"></p>
<p>The city of Chicago releases anonymized trip-level data on taxi trips in the city. We will use a dataset that pulls a sample of 10,000 rides occurring in early 2022.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Type <code>?taxi</code> to learn more about this dataset, including references.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidymodels)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="in">glimpse(taxi)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Rows: 10,000
#&gt; Columns: 7
#&gt; $ tip      &lt;fct&gt; yes, yes, yes, yes, yes, yes, yes, yes, yes, yes, yes, yes, yâ€¦
#&gt; $ distance &lt;dbl&gt; 17.19, 0.88, 18.11, 20.70, 12.23, 0.94, 17.47, 17.67, 1.85, 1â€¦
#&gt; $ company  &lt;fct&gt; Chicago Independents, City Service, other, Chicago Independenâ€¦
#&gt; $ local    &lt;fct&gt; no, yes, no, no, no, yes, no, no, no, no, no, no, no, yes, noâ€¦
#&gt; $ dow      &lt;fct&gt; Thu, Thu, Mon, Mon, Sun, Sat, Fri, Sun, Fri, Tue, Tue, Sun, Wâ€¦
#&gt; $ month    &lt;fct&gt; Feb, Mar, Feb, Apr, Mar, Apr, Mar, Jan, Apr, Mar, Mar, Apr, Aâ€¦
#&gt; $ hour     &lt;int&gt; 16, 8, 18, 8, 21, 23, 12, 6, 12, 14, 18, 11, 12, 19, 17, 13, â€¦</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>tip</code>: Whether the rider left a tip. A factor with levels â€œyesâ€ and â€œnoâ€.</p>
<p><code>distance</code>: The trip distance, in odometer miles.</p>
<p><code>company</code>: The taxi company, as a factor. Companies that occurred few times were binned as â€œotherâ€.</p>
<p><code>local</code>: Whether the trip started in the same community area as it began. See the source data for community area values.</p>
<p><code>dow</code>: The day of the week in which the trip began, as a factor.</p>
<p><code>month</code>: The month in which the trip began, as a factor.</p>
<p><code>hour</code>: The hour of the day in which the trip began, as a numeric.</p>
</div>
</div>
<section id="checklist-for-predictors" class="level3">
<h3 class="anchored" data-anchor-id="checklist-for-predictors">Checklist for predictors</h3>
<ul>
<li>Is it ethical to use this variable? (Or even legal?)</li>
<li>Will this variable be available at prediction time?</li>
<li>Does this variable contribute to explainability?</li>
</ul>
</section>
</section>
</section>
<section id="part-2-data-budget" class="level1">
<h1>PART 2: Data Budget</h1>
<p><img src="hexes/rsample.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
<section id="data-splitting-and-spending" class="level2">
<h2 class="anchored" data-anchor-id="data-splitting-and-spending">Data splitting and spending</h2>
<p>Always have a separate piece of data that can contradict what you believe!</p>
<p>For machine learning, we typically split data into training and test sets:</p>
<ul>
<li>The <strong>training set</strong> is used to estimate model parameters.</li>
<li>The <strong>test set</strong> is used to find an independent assessment of model performance. Do not ğŸš« use the test set during training. The test set is precious ğŸ’</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/test-train-split-1.svg" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>Spending too much data in <strong>training</strong> prevents us from computing a good assessment of predictive <strong>performance</strong>.</p></li>
<li><p>Spending too much data in <strong>testing</strong> prevents us from computing a good estimate of model <strong>parameters</strong>.</p></li>
</ul>
</section>
<section id="your-turn-1" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-1">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="when-is-a-good-time-to-split-your-data" class="anchored"><em>When is a good time to split your data?</em></h3></li>
</ul>
</section>
<section id="the-initial-split" class="level2">
<h2 class="anchored" data-anchor-id="the-initial-split">The initial split</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxi-split}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_split &lt;- initial_split(taxi)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_split</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;Training/Testing/Total&gt;
#&gt; &lt;7500/2500/10000&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How much data in training vs testing?
</div>
</div>
<div class="callout-body-container callout-body">
<p>This function uses a good default, but this depends on your specific goal/data. There are more powerful ways of splitting, like stratification, that we will get into later.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What is <code>set.seed()</code>?
</div>
</div>
<div class="callout-body-container callout-body">
<p>To create that split of the data, R generates â€œpseudo-randomâ€ numbers: while they are made to behave like random numbers, their generation is deterministic give a â€œseedâ€.</p>
<p>This allows us to reproduce results by setting that seed.</p>
<p>Which seed you pick doesnâ€™t matter, as long as you donâ€™t try a bunch of seeds and pick the one that gives you the best performance.</p>
</div>
</div>
</section>
<section id="accessing-the-data" class="level2">
<h2 class="anchored" data-anchor-id="accessing-the-data">Accessing the data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: taxi-train-test</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_train &lt;- training(taxi_split)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_test &lt;- testing(taxi_split)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="the-training-set" class="level3">
<h3 class="anchored" data-anchor-id="the-training-set">The training set</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: taxi-train</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_train</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 7,500 Ã— 7
#&gt;    tip   distance company                   local dow   month  hour
#&gt;    &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;                     &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;int&gt;
#&gt;  1 yes       0.7  Taxi Affiliation Services yes   Tue   Mar      18
#&gt;  2 yes       0.99 Sun Taxi                  yes   Tue   Jan       8
#&gt;  3 yes       1.78 other                     no    Sat   Mar      22
#&gt;  4 yes       0    Taxi Affiliation Services yes   Wed   Apr      15
#&gt;  5 yes       0    Taxi Affiliation Services no    Sun   Jan      21
#&gt;  6 yes       2.3  other                     no    Sat   Apr      21
#&gt;  7 yes       6.35 Sun Taxi                  no    Wed   Mar      16
#&gt;  8 yes       2.79 other                     no    Sun   Feb      14
#&gt;  9 yes      16.6  other                     no    Sun   Apr      18
#&gt; 10 yes       0.02 Chicago Independents      yes   Sun   Apr      15
#&gt; # â„¹ 7,490 more rows</code></pre>
</div>
</div>
</section>
<section id="the-test-set" class="level3">
<h3 class="anchored" data-anchor-id="the-test-set">The test set</h3>
<p>ğŸ™ˆ</p>
<p>There are 2500 rows and 7 columns in the test set.</p>
</section>
</section>
<section id="your-turn-2" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-2">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="split-your-data-so-20-is-held-out-for-the-test-set-and-show-the-first-10-rows-of-so-of-the-training-data" class="anchored"><em>Split your data so 20% is held out for the test set and show the first 10 rows of so of the training data</em></h3></li>
</ul>
<ul>
<li><h3 id="try-out-different-values-in-set.seed-to-see-how-the-results-change." class="anchored"><em>Try out different values in <code>set.seed()</code> to see how the results change.</em></h3></li>
</ul>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory data analysis</h2>
<p>As you know by now, before we get too far into our data analysis, we want to do some exploration with visualizations. So lets get to it.</p>
</section>
<section id="your-turn-3" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-3">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="whats-the-distribution-of-the-outcome-tip" class="anchored"><em>Whatâ€™s the distribution of the outcome, <code>tip</code>?</em></h3></li>
<li><h3 id="whats-the-distribution-of-numeric-variables-like-distance" class="anchored"><em>Whatâ€™s the distribution of numeric variables like <code>distance</code>?</em></h3></li>
<li><h3 id="how-does-tip-differ-across-the-categorical-variables" class="anchored"><em>How does <code>tip</code> differ across the categorical variables?</em></h3></li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Open only after youâ€™ve attempted to generate a few plots on your own
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For <code>taxi-tip-counts</code>, what about using <code>geom_bar()</code> with just <code>tip</code>?</p>
<p>For <code>taxi-tip-by-distance</code>, I would recommend <code>geom_histograms</code> and play around with the bin size. You will also want to incorporate <code>facet_grid</code>.</p>
<p>For <code>taxi-tip-by-hour</code>, I would plot making use of <code>fill=</code> and <code>geom_bar</code></p>
<p>For <code>taxi-tip-by-local</code>, Iâ€™ll leave this one up to you, but add a colore palette for color-blind people.</p>
</div>
</div>
</div>
</section>
<section id="split-smarter" class="level2">
<h2 class="anchored" data-anchor-id="split-smarter">Split smarter</h2>
<p>Based on our EDA, we know that the source data contains fewer <code>"no"</code> tip values than <code>"yes"</code>. We want to make sure we allot equal proportions of those responses so that both the training and testing data have enough of each to give accurate estimates.</p>
<p><strong>Stratified sampling</strong> would split within response values</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Proof that there are fewer â€œnoâ€ tips through EDA
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/taxi-tip-pct-1.svg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>For stratification involving regression, determine the quartiles of the data set and sample within those artificial groups</li>
<li>For time series, we often use the most recent data as the test set</li>
</ul>
</div>
</div>
</section>
<section id="your-turn-4" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-4">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="go-back-and-modify-your-earlier-code-where-you-split-the-data-to-stratify-by-tip" class="anchored"><em>Go back and modify your earlier code where you split the data to stratify by tip</em></h3></li>
</ul>
</section>
</section>
<section id="part-3-fitting-a-model" class="level1">
<h1>PART 3: Fitting a model</h1>
<p><img src="hexes/parsnip.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
<section id="do-it-the-tidymodels-way" class="level2">
<h2 class="anchored" data-anchor-id="do-it-the-tidymodels-way">Do it the tidymodels way</h2>
<ul>
<li>Choose a model</li>
<li>Specify an engine</li>
<li>Set the mode</li>
</ul>
<section id="choose-a-model" class="level3">
<h3 class="anchored" data-anchor-id="choose-a-model">Choose a model</h3>
<p>The model type differentiates basic modeling approaches, such as linear regression, logistic regression, linear support vector machines, etc.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What models are available to you?
</div>
</div>
<div class="callout-body-container callout-body">
<p>All available models are listed at <a href="https://www.tidymodels.org/find/parsnip/" class="uri">https://www.tidymodels.org/find/parsnip/</a></p>
</div>
</div>
<p>How about we start with a good olâ€™ linear regression model?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r logistic-reg}</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="in">linear_reg()</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear Regression Model Specification (regression)
#&gt; 
#&gt; Computational engine: lm</code></pre>
</div>
</div>
</section>
<section id="specify-an-engine" class="level3">
<h3 class="anchored" data-anchor-id="specify-an-engine">Specify an engine</h3>
<p><strong>Question:</strong> How many ways are there to fit a linear model in R?</p>
<section id="lots-of-ways" class="level4">
<h4 class="anchored" data-anchor-id="lots-of-ways">Lots of ways!</h4>
<ul>
<li><p><code>lm</code> for linear model (default)</p></li>
<li><p><code>glm</code> for generalized linear model</p></li>
<li><p><code>glmnet</code> for regularized regression</p></li>
<li><p><code>keras</code> for regression using TensorFlow</p></li>
<li><p><code>stan</code> for Bayesian regression</p></li>
<li><p><code>spark</code> for large data sets</p></li>
</ul>
<p>The computational engine indicates how the model is fit, such as with a specific R package implementation or even methods outside of R like Keras or Stan.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note that some models when you call them have a default engine associated with them, but these can be easily overridden depending on your needs
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r logistic-reg-glmnet}</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="in">linear_reg() %&gt;% </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("glm", family = stats::poisson(link = "log"))</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear Regression Model Specification (regression)
#&gt; 
#&gt; Engine-Specific Arguments:
#&gt;   family = stats::poisson(link = "log")
#&gt; 
#&gt; Computational engine: glm</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r logistic-reg-stan}</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="in">linear_reg() %&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("stan")</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear Regression Model Specification (regression)
#&gt; 
#&gt; Computational engine: stan</code></pre>
</div>
</div>
</section>
</section>
<section id="set-the-mode" class="level3">
<h3 class="anchored" data-anchor-id="set-the-mode">Set the mode</h3>
<p>The mode denotes in what kind of modeling context it will be used (most commonly, classification or regression)</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that some models have a default mode, some do not</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r decision-tree}</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="in">decision_tree()</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Decision Tree Model Specification (unknown mode)
#&gt; 
#&gt; Computational engine: rpart</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r decision-tree-2}</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="in">decision_tree() %&gt;% </span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("classification")</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Decision Tree Model Specification (classification)
#&gt; 
#&gt; Computational engine: rpart</code></pre>
</div>
</div>
</section>
</section>
<section id="your-turn-5" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-5">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="copy-the-chunk-below-and-edit-the-code-to-create-a-logistic-regression-model" class="anchored"><em>Copy the chunk below and edit the code to create a logistic regression model</em></h3></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="in"># Model</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="in">linear_reg()</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="in"># Engine</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="in">linear_reg() %&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="in">  set_engine("glmnet")</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="in"># Mode (some models have a default mode, others don't)</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="in">decision_tree() %&gt;% </span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("regression")</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="models-well-be-using-today" class="level2">
<h2 class="anchored" data-anchor-id="models-well-be-using-today">Models weâ€™ll be using today</h2>
<ul>
<li>Logistic regression (you)</li>
<li>Decision trees (me)</li>
</ul>
<section id="logistic-regression" class="level3">
<h3 class="anchored" data-anchor-id="logistic-regression">Logistic regression</h3>
<p><strong>The concept of odds and probability:</strong></p>
<ul>
<li>The <strong>probability</strong> of some event happening can be expressed as a value between 0 and 1</li>
<li>If the probability of an event occurring is <span class="math inline">\({p}\)</span>, the <strong>odds</strong> of an event occurring can be expressed as <span class="math inline">\(\frac{p}{1 - p}\)</span></li>
</ul>
<p>â€œIf there is a 75% chance (or 0.75 probability) that it will rain today, thenâ€¦ the odds of it raining are 3 to 1, meaning that it is 3 times more likely to rain than not.â€</p>
<p><strong>From odds to log-odds:</strong></p>
<ul>
<li>Itâ€™s challenging to work with odds in mathematical modeling, especially when there are multiple factors that might affect an outcome</li>
<li>This is why we take the logarithm of the odds which puts it on a scale that is easier to work with</li>
</ul>
<p><strong>The Logistic Regression Equation:</strong></p>
<p><span class="math inline">\(log(\frac{p}{1 - p}) = \beta_0 + \beta_1\cdot \text{A}\)</span></p>
<ul>
<li><span class="math inline">\(log(\frac{p}{1 - p})\)</span> is the log-odds (or the logit) of the probability of our event of interest (e.g., getting a tip)</li>
<li><span class="math inline">\(\beta_0\)</span> is the intercept, which represents the log-odds of the event when predictor A is zero</li>
<li><span class="math inline">\(\beta_1\cdot \text{A}\)</span> is the slope of coefficient for predictor <code>A</code>, indicating how much the log-odds of the event changes with a one-unit change in <code>A</code></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is common to convert the log-odds units into what is called an odds ratio (OR)</p>
</div>
</div>
<p><strong>Relating this back to taxiâ€™s and tips</strong></p>
<ul>
<li>We want to predict whether someone will tip (â€œoneâ€) or not based on the trip distance, in odometer meters (<code>A</code>).</li>
<li><span class="math inline">\(\beta_0\)</span> would represent the log-odds of receiving a tip with zero distance</li>
<li><span class="math inline">\(\beta_1\)</span> shows how the log-odds of receiving a tip with each additional meter in distance</li>
<li>Maybe as distance increases, the probability of getting a tip increases? (but not linearly- there are diminishing returns after a certain point)</li>
</ul>
</section>
<section id="a-possibly-helpful-visual" class="level3">
<h3 class="anchored" data-anchor-id="a-possibly-helpful-visual">A possibly helpful visual</h3>
<ul>
<li>Lets simulate a dataset of 500 observations with a single predictor <code>A</code> using our logistic regression equation. We ensure that the log-odds of the binary outcome (<code>class</code> with levels â€œzeroâ€ and â€œoneâ€) increases with respect to <code>A</code> with an intercept of <code>.1</code> and a slope of <code>2</code>.</li>
<li>Estimate the probability (converting log-odds to probabilities) of the â€œoneâ€ class for different values of <code>A</code> and plot these (<code>A</code> values are binned in 0.5 increments; error bars show the confidence intervals for estimates)</li>
<li>The visual demonstrates the concept of the odds and probabilities changing in a non-linear fashion across the range of <code>A</code>, a key concept in logistic regression.</li>
</ul>
<p>What a logistic regression is doing is trying to fit this sort of sigmoid line to separate the two classes in an outcome.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/plot-logistic-reg-1.svg" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="decision-trees" class="level3">
<h3 class="anchored" data-anchor-id="decision-trees">Decision trees</h3>
<p><strong>An analogy</strong></p>
<ul>
<li>Letâ€™s play 20 questions: Iâ€™m thinking of a person, place, or thing. Guess it with asking â€œyesâ€ or â€œnoâ€ questions</li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Seriously, can you guess what or who or where Iâ€™m thinking about?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/titantic.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="200"></p>
</figure>
</div>
</div>
</div>
</div>
<p><strong>A slightly more formal characterization</strong></p>
<ul>
<li>A decision tree is a flowchart-like tree structure consisting of splits or if/then statements based on predictors</li>
</ul>
<p><strong>But to explain, visualizations are best for decision trees</strong></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/unnamed-chunk-14-1.svg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Variable explanations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><code>0</code> corresponds to â€œDid Not Surviveâ€; <code>1</code> corresponds to â€œSurvivedâ€</p>
<p><code>Pclass:</code> Passenger Class. This is a categorical feature indicating the class of travel of the passenger aboard the Titanic. It typically has three categories: - 1 for first-class (the highest class), - 2 for second-class, - 3 for third-class (the lowest class).</p>
<p><code>Sex:</code> The sex of the passenger (male or female). This is a binary categorical feature.</p>
<p><code>Age:</code> The age of the passenger. This is a continuous numerical feature.</p>
<p><code>SibSp:</code> The number of siblings or spouses the passenger had aboard the Titanic. This is a discrete numerical feature.</p>
<p><code>Parch:</code> The number of parents or children the passenger had aboard the Titanic. This is also a discrete numerical feature. Note that some relations, like nannies or friends, may not be included in this count.</p>
<p><code>Fare:</code> The amount of money the passenger paid for the ticket. This is a continuous numerical feature.</p>
</div>
</div>
</div>
<p><strong>A few things to keep in mind</strong></p>
<ul>
<li>A tree chooses a feature and a split point (e.g., if <code>Age &gt;= 6.5</code>) to partition the data into subsets that are as homogeneous â€œpureâ€ as possible (meaning that the node contains data points from predominantly one class)
<ul>
<li>Just know there are measures for evaluating the â€œpurityâ€ of a node, e.g., Gini Impurity, Entropy, Classification Error</li>
</ul></li>
<li>This process is repeated recursively, forming a tree structure until certain stopping criteria are met (e.g., when a node has a small number of observations, some maximum depth).</li>
<li>Trees are also <strong>pruned</strong> to reduce its complexity</li>
</ul>
</section>
<section id="another-possibly-helpful-visual" class="level3">
<h3 class="anchored" data-anchor-id="another-possibly-helpful-visual">Another possibly helpful visual</h3>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/plot-tree-fit-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="480"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/plot-tree-preds-1.svg" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p><img src="hexes/workflows.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
</section>
</section>
<section id="model-workflows" class="level2">
<h2 class="anchored" data-anchor-id="model-workflows">Model workflows</h2>
<ul>
<li>In tidymodels, there is this idea that a model-oriented data analysis consists of a preprocessor and a model, and these should be built into a single â€œworkflowâ€ object
<ul>
<li><strong>Preprocessors</strong> range from simple formulas <code>y ~ x1 + x2</code> to sophisticated <code>recipes</code> that allow feature engineering operations (e.g., extract features using a PCA), remove variables with zero variances, categorizes missing categorical data (NAâ€™s) as <code>unknown</code>, dummy codes categorical variables, and lots more</li>
<li><strong>Models</strong> allow different ways to fit the data</li>
</ul></li>
<li><strong>By packaging preprocessing steps and modeling in one workflow, lots of advantages!</strong>
<ul>
<li>Ensures that new data goes through the same preprocessing steps as training data</li>
<li>Ensures consistency and reproducibility</li>
<li>They can help organize your work when working with multiple models</li>
<li>Handles new data better than base R tools in terms of new factor levels</li>
</ul></li>
</ul>
<p><img src="hexes/workflows.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"> <img src="hexes/parsnip.png" class="absolute" data-top="-20" data-right="64" width="64" height="74"></p>
</section>
<section id="a-model-workflow" class="level2">
<h2 class="anchored" data-anchor-id="a-model-workflow">A model workflow</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r tree-wflow}</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="in">#logi_spec &lt;-</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="in">tree_spec &lt;-                            # set up all the specs on model</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="in">  decision_tree(cost_complexity = 0.002) %&gt;%   </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="in">  set_mode("classification")</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="in">#logi_wflow &lt;-</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="in">tree_wflow &lt;- workflow() %&gt;%            # build the workflow</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(tip ~ .) %&gt;%              # preprocessor steps (could be lots!)</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(tree_spec)                  # add model</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="in">#logi_fit &lt;-                            </span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="in">tree_fit &lt;-                             # now fit to training data </span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="in">  tree_wflow %&gt;% </span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="in">  fit(data = taxi_train) </span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>â€œShortcutâ€ by specifying the preprocessor and model specs directly in the <code>workflow()</code> call:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">workflow</span>(tip <span class="sc">~</span> ., tree_spec) <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> taxi_train) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="your-turn-6" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-6">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="copy-the-chunk-above-r-tree-wflow-and-edit-the-code-to-create-a-workflow-for-a-logistic-regression-model" class="anchored"><em>Copy the chunk above â€œ{r tree-wflow}â€ and edit the code to create a workflow for a logistic regression model</em></h3>
<ul>
<li>Make sure you swap out <code>tree_*</code> for <code>logi_*</code> when saving each set of code</li>
</ul></li>
</ul>
<p><img src="hexes/recipes.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
</section>
<section id="pre-processing-adding-recipes" class="level2">
<h2 class="anchored" data-anchor-id="pre-processing-adding-recipes">Pre-processing: Adding â€œrecipesâ€</h2>
<ul>
<li>Hypothetical additions just for illustrative purposes</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: false</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="in">tree_rec &lt;-</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="in">  step_date(some_var1, features = c("dow", "month", "year")) %&gt;% </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="in">  step_rm(some_var1) %&gt;% </span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="in">  step_dummy(all_nominal_predictors()) %&gt;% </span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="in">  step_zv(all_predictors()) %&gt;% </span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="in">  step_normalize(all_numeric_predictors()) %&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="in">  step_pca(all_numeric_predictors())</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="in">#logi_wflow &lt;-</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="in">tree_wflow &lt;- workflow() %&gt;%            # build the workflow</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="in">  add_formula(tip ~ .) %&gt;%              # preprocessor: add formula</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="in">  add_recipe(tree_rec) %&gt;%              # preprocessor: add recipe</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="in">  add_model(tree_spec)                  # add model</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Visit <a href="https://www.tidymodels.org/find/recipes/" class="uri">https://www.tidymodels.org/find/recipes/</a> for details on all possible recipes</li>
</ul>
</section>
<section id="how-do-you-understand-your-new-tree_fit-model" class="level2">
<h2 class="anchored" data-anchor-id="how-do-you-understand-your-new-tree_fit-model">How do you <strong>understand</strong> your new <code>tree_fit</code> model?</h2>
<!-- Could talk about broom methods for looking at fitted objects: glance, tidy, only focusing on augment as set up for prediction -->
<section id="predict-with-your-model" class="level4">
<h4 class="anchored" data-anchor-id="predict-with-your-model">Predict with your model</h4>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
What happens when you run <code>predict(logi_fit, new_data = taxi_test)</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="in">predict(tree_fit, new_data = taxi_test)</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2,000 Ã— 1
#&gt;    .pred_class
#&gt;    &lt;fct&gt;      
#&gt;  1 yes        
#&gt;  2 yes        
#&gt;  3 yes        
#&gt;  4 yes        
#&gt;  5 yes        
#&gt;  6 yes        
#&gt;  7 yes        
#&gt;  8 yes        
#&gt;  9 yes        
#&gt; 10 yes        
#&gt; # â„¹ 1,990 more rows</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_test)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2,000 Ã— 10
#&gt;    .pred_class .pred_yes .pred_no tip   distance company local dow   month  hour
#&gt;    &lt;fct&gt;           &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;int&gt;
#&gt;  1 yes             0.967   0.0333 yes      20.7  Chicagâ€¦ no    Mon   Apr       8
#&gt;  2 yes             0.917   0.0830 yes       1.47 City Sâ€¦ no    Tue   Mar      14
#&gt;  3 yes             0.917   0.0830 yes       1    Taxi Aâ€¦ no    Mon   Feb      18
#&gt;  4 yes             0.917   0.0830 yes       1.91 Flash â€¦ no    Wed   Apr      15
#&gt;  5 yes             0.967   0.0333 yes      17.2  City Sâ€¦ no    Mon   Apr       9
#&gt;  6 yes             0.967   0.0333 yes      17.8  City Sâ€¦ no    Mon   Mar       9
#&gt;  7 yes             0.917   0.0830 yes       0.53 Taxicaâ€¦ yes   Wed   Apr       8
#&gt;  8 yes             0.917   0.0830 yes       1.77 other   no    Thu   Apr      15
#&gt;  9 yes             0.967   0.0333 yes      18.6  Flash â€¦ no    Thu   Apr      12
#&gt; 10 yes             0.917   0.0830 no        1.13 other   no    Sat   Feb      14
#&gt; # â„¹ 1,990 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The tidymodels prediction guarantee!
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>The predictions will always be inside a <strong>tibble</strong></li>
<li>The column names and types are <strong>unsurprising</strong> and <strong>predictable</strong></li>
<li>The number of rows in <code>new_data</code> and the output <strong>are the same</strong></li>
</ul>
</div>
</div>
</section>
<section id="bonus-for-decision-trees-visualization" class="level4">
<h4 class="anchored" data-anchor-id="bonus-for-decision-trees-visualization">Bonus: For decision trees, visualization</h4>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/plot-tree-fit-4-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Additional methods for understanding models
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Overall variable importance, such as with the <a href="https://koalaverse.github.io/vip/">vip</a> package</p></li>
<li><p>Flexible model explainers, such as with the <a href="https://dalex.drwhy.ai/">DALEXtra</a> package. <em>Works by removing a variable and see the effect on prediction, if the variable is important it will really wreck with the fit accuracy</em></p></li>
</ul>
</div>
</div>
<p>Learn more at <a href="https://www.tmwr.org/explain.html" class="uri">https://www.tmwr.org/explain.html</a></p>
</section>
</section>
<section id="your-turn-7" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-7">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="for-the-fitted-logistic-regression-model-use-augment-then-glance-and-tidy.-what-happens-with-each" class="anchored"><em>For the fitted logistic regression model, use <code>augment</code>, then <code>glance</code> and <code>tidy</code>. What happens with each?</em></h3></li>
</ul>
<p><img src="hexes/yardstick.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
</section>
</section>
<section id="part-4-metrics-for-model-performance" class="level1">
<h1>PART 4: Metrics for model performance</h1>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the following we will be working on evaluation metrics based on the training set data, but keep in mind that you also need to run the metrics on the test data. If you fail to do so, it can give a misleading impression of model performance. Hopefully this will be clearer soon.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxi-fit-augment}</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="in">  relocate(tip, .pred_class, .pred_yes, .pred_no)</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 8,000 Ã— 10
#&gt;    tip   .pred_class .pred_yes .pred_no distance company local dow   month  hour
#&gt;    &lt;fct&gt; &lt;fct&gt;           &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;int&gt;
#&gt;  1 yes   yes             0.967   0.0333    17.2  Chicagâ€¦ no    Thu   Feb      16
#&gt;  2 yes   yes             0.917   0.0830     0.88 City Sâ€¦ yes   Thu   Mar       8
#&gt;  3 yes   yes             0.967   0.0333    18.1  other   no    Mon   Feb      18
#&gt;  4 yes   yes             0.858   0.142     12.2  Chicagâ€¦ no    Sun   Mar      21
#&gt;  5 yes   yes             0.917   0.0830     0.94 Sun Taâ€¦ yes   Sat   Apr      23
#&gt;  6 yes   yes             0.967   0.0333    17.5  Flash â€¦ no    Fri   Mar      12
#&gt;  7 yes   yes             0.967   0.0333    17.7  other   no    Sun   Jan       6
#&gt;  8 yes   yes             0.917   0.0830     1.85 Taxicaâ€¦ no    Fri   Apr      12
#&gt;  9 yes   yes             0.917   0.0830     0.53 Sun Taâ€¦ no    Tue   Mar      18
#&gt; 10 yes   yes             0.858   0.142      6.65 Taxicaâ€¦ no    Sun   Apr      11
#&gt; # â„¹ 7,990 more rows</code></pre>
</div>
</div>
<section id="confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="confusion-matrix">Confusion matrix</h2>
<p><img src="img/confusion-matrix.png" class="img-fluid"></p>
<p><code>conf_mat()</code> can be used to see how well the model is doing at prediction</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r conf-mat-plot}</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="in">  conf_mat(truth = tip, estimate = .pred_class) %&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="in">  autoplot(type = "heatmap")</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/conf-mat-plot-1.svg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="accuracy" class="level2">
<h2 class="anchored" data-anchor-id="accuracy">Accuracy</h2>
<p>This is a straightforward measure of the proportion of correct predictions out of all predictions.</p>
<p><img src="img/confusion-matrix-accuracy.png" class="img-fluid" width="500"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r acc-2}</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(.pred_class = factor("yes", levels = c("yes", "no"))) %&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy(truth = tip, estimate = .pred_class)</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric  .estimator .estimate
#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy binary         0.923</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Dangers of accuracy
</div>
</div>
<div class="callout-body-container callout-body">
<p>We need to be careful of using <code>accuracy()</code> since it can give â€œgoodâ€ performance by only predicting one way with imbalanced data</p>
</div>
</div>
</section>
<section id="sensitivity" class="level2">
<h2 class="anchored" data-anchor-id="sensitivity">Sensitivity</h2>
<p>Where accuracy provides a quick understanding of how often the model is correct, sensitivity is an important measure when the cost of missing a positive case (false negative) is high. In our scenario, a positive case is the outcome variable coded as â€œ1â€ (tip: yes). In other scenarios, this is more consequential (such as correctly predicting the percentage of sick people who have some targeted condition).</p>
<p><img src="img/confusion-matrix-sensitivity.png" class="img-fluid" width="500"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r sens}</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="in">  sensitivity(truth = tip, estimate = .pred_class)</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric     .estimator .estimate
#&gt;   &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 sensitivity binary         0.998</code></pre>
</div>
</div>
</section>
<section id="specificity" class="level2">
<h2 class="anchored" data-anchor-id="specificity">Specificity</h2>
<p>This is essentially the compliment of sensitivity. Specificity is an important measure of how well the model correctly predicts the true negative. In our scenario, a true negative is the outcome variable coded as â€œ0â€ (tip: no). Pay attention to specificity when the cost of a false positive is high (like convicting an innocent person).</p>
<p><img src="img/confusion-matrix-specificity.png" class="img-fluid" width="500"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r spec}</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="in">  specificity(truth = tip, estimate = .pred_class)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric     .estimator .estimate
#&gt;   &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 specificity binary        0.0390</code></pre>
</div>
</div>
</section>
<section id="combining-the-metrics" class="level2">
<h2 class="anchored" data-anchor-id="combining-the-metrics">Combining the metrics</h2>
<p>We can use <code>metric_set()</code> to combine multiple calculations into a single table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxi-metrics}</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_metrics &lt;- metric_set(accuracy, specificity, sensitivity)</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="in">  taxi_metrics(truth = tip, estimate = .pred_class)</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 3 Ã— 3
#&gt;   .metric     .estimator .estimate
#&gt;   &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy    binary        0.924 
#&gt; 2 specificity binary        0.0390
#&gt; 3 sensitivity binary        0.998</code></pre>
</div>
</div>
<p>All yardstick metric functions work with grouped data frames!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxi-metrics-grouped}</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_metrics &lt;- metric_set(accuracy, specificity, sensitivity)</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;%</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(local) %&gt;%</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="in">  taxi_metrics(truth = tip, estimate = .pred_class)</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 6 Ã— 4
#&gt;   local .metric     .estimator .estimate
#&gt;   &lt;fct&gt; &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 yes   accuracy    binary        0.893 
#&gt; 2 no    accuracy    binary        0.932 
#&gt; 3 yes   specificity binary        0.0181
#&gt; 4 no    specificity binary        0.0467
#&gt; 5 yes   sensitivity binary        1     
#&gt; 6 no    sensitivity binary        0.998</code></pre>
</div>
</div>
</section>
<section id="your-turn-8" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-8">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h2 id="compute-a-confusion-matrix-for-your-logistic-model-and-produce-a-table-that-shows-its-accuracy-specificity-sensitivity-scores" class="anchored"><em>Compute a confusion matrix for your logistic model and produce a table that shows its accuracy, specificity, sensitivity scores</em></h2></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
An important aside: Two class data
</div>
</div>
<div class="callout-body-container callout-body">
<p>These metrics assume that we know the threshold for converting â€œsoftâ€ probability predictions into â€œhardâ€ class predictions.</p>
<p>Is a 50% threshold good?</p>
<p>What happens if we say that we need to be 80% sure to declare an event?</p>
<ul>
<li>sensitivity â¬‡ï¸, specificity â¬†ï¸ In other words: more likely to predict negatives(no tips)</li>
</ul>
<p>What happens for a 20% threshold?</p>
<ul>
<li>sensitivity â¬†ï¸, specificity â¬‡ï¸ In other words: more likely to predict positives(yes tips)</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/thresholds-1.svg" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p><img src="hexes/yardstick.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
</section>
<section id="roc-curves" class="level2">
<h2 class="anchored" data-anchor-id="roc-curves">ROC curves</h2>
<p>An ROC (receiver operator characteristic) curve is a graphical plot that illustrates the diagnostic ability of a binary classifier system.</p>
<p><strong>It primarily:</strong></p>
<ul>
<li>Calculates the sensitivity and specificity for all possible thresholds. It helps you (in a visual way) understand whether a model is optimally balancing sensitivity and specificity in a way that makes sense</li>
</ul>
<p><strong>It is created by:</strong></p>
<ul>
<li>Plotting true positive rate (TPR, or sensitivity) against the false positive rate (FPR, 1-sensitivity) at various threshold settings</li>
<li>In other words: plotting the rate in which the models correctly predict â€œtip=yesâ€ and the rate in which the models mistakenly predict that â€œtip=yesâ€ at various points above which a prediction is considered to be of the positive class.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why 1-sensitivity for FPR?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Given that sensitivity is the true positive rate, and specificity is the true negative rate. Hence <code>1 - specificity</code> is the false positive rate.</p>
</div>
</div>
<p><strong>Hereâ€™s the ROC curve for our model based on the training data:</strong></p>
<div class="cell" data-output-location="column">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r roc-curve}</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-width: 6</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-height: 6</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="in">#| output-location: "column"</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;% </span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_curve(truth = tip, .pred_yes) %&gt;%</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="in">  autoplot() +</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x="FPR, 1-specificity", y="TPR, or sensitivity")</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="taxi-tips_files/figure-html/roc-curve-1.svg" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p><strong>How do we interpret:</strong></p>
<ul>
<li><p>A high Area Under the Curve (AUC) indicates that for the majority of thresholds, the TPR (sensitivity) was high and the FPR was low. It means that the model has a good measure of separability and is capable of distinguishing between the positive and negative classes across a wide range of thresholds.</p></li>
<li><p>ROC AUC = 1 ğŸ’¯</p></li>
<li><p>ROC AUC = 1/2 ğŸ˜¢</p></li>
</ul>
<p><strong>Letâ€™s get the actual value for AUC:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r roc-auc}</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;% </span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_auc(truth = tip, .pred_yes)</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.611</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>ROC curves are insensitive to class imbalance.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you look at a ROC curve, each point corresponds to a threshold, but the curve itself does not tell you what these thresholds are. To find out, you would need to refer back to the data used to create the ROC curve.</p>
</div>
</div>
</section>
<section id="your-turn-9" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-9">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="compute-and-plot-an-roc-curve-for-your-logistic-model" class="anchored"><em>Compute and plot an ROC curve for your logistic model</em></h3></li>
</ul>
</section>
</section>
<section id="part-5-using-resampling-to-estimate-performance" class="level1">
<h1>PART 5: Using resampling to estimate performance</h1>
<section id="dangers-of-overfitting" class="level2">
<h2 class="anchored" data-anchor-id="dangers-of-overfitting">âš ï¸ Dangers of Overfitting âš ï¸</h2>
<p>Models can easily be overfitted to the training data, meaning they perform well on the training data but poorly on unseen data.</p>
<section id="fitting-to-your-training-data" class="level3">
<h3 class="anchored" data-anchor-id="fitting-to-your-training-data">Fitting to your training data</h3>
<p><img src="https://raw.githubusercontent.com/topepo/2022-nyr-workshop/main/images/tuning-overfitting-train-1.svg" class="img-fluid"></p>
</section>
<section id="problems-when-generalizing-to-test-data" class="level3">
<h3 class="anchored" data-anchor-id="problems-when-generalizing-to-test-data">Problems when generalizing to test data</h3>
<p><img src="https://raw.githubusercontent.com/topepo/2022-nyr-workshop/main/images/tuning-overfitting-test-1.svg" class="img-fluid"></p>
</section>
<section id="is-our-model-doing-well-on-training-but-poorly-on-new-data" class="level3">
<h3 class="anchored" data-anchor-id="is-our-model-doing-well-on-training-but-poorly-on-new-data">Is our model doing well on training but poorly on new data?</h3>
<!-- We call this "resubstitution" or "repredicting the training set" -->
<!-- We call this a "resubstitution estimate" -->
<p><strong>Hereâ€™s our model performance on the training data</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r augment-train}</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="in">tree_fit %&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="in">  augment(taxi_train)</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 8,000 Ã— 10
#&gt;    .pred_class .pred_yes .pred_no tip   distance company local dow   month  hour
#&gt;    &lt;fct&gt;           &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt; &lt;int&gt;
#&gt;  1 yes             0.967   0.0333 yes      17.2  Chicagâ€¦ no    Thu   Feb      16
#&gt;  2 yes             0.917   0.0830 yes       0.88 City Sâ€¦ yes   Thu   Mar       8
#&gt;  3 yes             0.967   0.0333 yes      18.1  other   no    Mon   Feb      18
#&gt;  4 yes             0.858   0.142  yes      12.2  Chicagâ€¦ no    Sun   Mar      21
#&gt;  5 yes             0.917   0.0830 yes       0.94 Sun Taâ€¦ yes   Sat   Apr      23
#&gt;  6 yes             0.967   0.0333 yes      17.5  Flash â€¦ no    Fri   Mar      12
#&gt;  7 yes             0.967   0.0333 yes      17.7  other   no    Sun   Jan       6
#&gt;  8 yes             0.917   0.0830 yes       1.85 Taxicaâ€¦ no    Fri   Apr      12
#&gt;  9 yes             0.917   0.0830 yes       0.53 Sun Taâ€¦ no    Tue   Mar      18
#&gt; 10 yes             0.858   0.142  yes       6.65 Taxicaâ€¦ no    Sun   Apr      11
#&gt; # â„¹ 7,990 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r augment-acc}</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="in">tree_fit %&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="in">  augment(taxi_train) %&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy(tip, .pred_class)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric  .estimator .estimate
#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy binary         0.924</code></pre>
</div>
</div>
<p><strong>Hereâ€™s our model performance on the test data (unseen data)</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r augment-acc-test}</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="in">tree_fit %&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="in">  augment(taxi_test) %&gt;%</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy(tip, .pred_class)</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric  .estimator .estimate
#&gt;   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy binary         0.914</code></pre>
</div>
</div>
</section>
<section id="better-to-fit-on-training-data-via-a-process-of-resampling" class="level3">
<h3 class="anchored" data-anchor-id="better-to-fit-on-training-data-via-a-process-of-resampling">Better to fit on training data via a process of resampling</h3>
<p>Resampling is basically an empirical simulation system used to understand how well the model would work on new data. Itâ€™s a more robust estimate of the modelâ€™s performance</p>
</section>
</section>
<section id="v-fold-k-fold-cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="v-fold-k-fold-cross-validation">V-fold (K-fold) Cross-validation</h2>
<ul>
<li>We want to repeatedly sample (â€œfoldâ€) the training data to create unique subsets (e.g., Resample 1, Resample 2, Resample <em>B</em>) for analysis and assessment</li>
</ul>
<p><img src="https://www.tmwr.org/premade/resampling.svg" class="img-fluid"></p>
<ul>
<li>Here, we randomly split the training data into V (or K) distinct blocks of roughly equal size (AKA the â€œfoldsâ€)</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.tmwr.org/premade/three-CV.svg" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li>In Fold 1:
<ul>
<li>We leave out the first block of analysis data and fit a model</li>
<li>This model is used to predict the held-out block of assessment data</li>
</ul></li>
<li>We continue this process until weâ€™ve predicted all V assessment blocks</li>
<li>This process ensures that every observation from the original dataset has the chance of appearing in the analysis and assessment set</li>
</ul>
<p><img src="https://www.tmwr.org/premade/three-CV-iter.svg" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Other advantages of resampling with V-fold cross-validation
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p><strong>Efficient use of data:</strong> When the amount of data is limited, itâ€™s a way to use every data point in both the training and validation</p></li>
<li><p><strong>Model tuning:</strong> Useful method for selecting the model with the best tuning parameters (hyperparameters). You can perform cross-validation for various combinations of parameters and choose the one that performs best.</p></li>
<li><p><strong>Comparing models</strong> What if we want to compare more models to see if there are important differences? Cross-validation allows us to do just this with just the <em>training</em> data</p></li>
</ul>
</div>
</div>
</section>
<section id="your-turn-10" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-10">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="if-we-use-10-folds-what-percent-of-the-training-data-ends-up-in-analysis-for-each-fold-for-assessment-for-each-fold" class="anchored"><em>If we use 10 folds, what percent of the training data ends up in ANALYSIS for each fold? for ASSESSMENT for each fold?</em></h3></li>
</ul>
<p><img src="hexes/rsample.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
</section>
<section id="lets-do-some-cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="lets-do-some-cross-validation">Letâ€™s do some cross-validation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r vfold-cv}</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="in">vfold_cv(taxi_train) # v = 10 is default</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; #  10-fold cross-validation 
#&gt; # A tibble: 10 Ã— 2
#&gt;    splits             id    
#&gt;    &lt;list&gt;             &lt;chr&gt; 
#&gt;  1 &lt;split [7200/800]&gt; Fold01
#&gt;  2 &lt;split [7200/800]&gt; Fold02
#&gt;  3 &lt;split [7200/800]&gt; Fold03
#&gt;  4 &lt;split [7200/800]&gt; Fold04
#&gt;  5 &lt;split [7200/800]&gt; Fold05
#&gt;  6 &lt;split [7200/800]&gt; Fold06
#&gt;  7 &lt;split [7200/800]&gt; Fold07
#&gt;  8 &lt;split [7200/800]&gt; Fold08
#&gt;  9 &lt;split [7200/800]&gt; Fold09
#&gt; 10 &lt;split [7200/800]&gt; Fold10</code></pre>
</div>
</div>
<p><strong>What is in this?</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxi-splits}</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_folds &lt;- vfold_cv(taxi_train)</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_folds$splits[1:3]</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; &lt;Analysis/Assess/Total&gt;
#&gt; &lt;7200/800/8000&gt;
#&gt; 
#&gt; [[2]]
#&gt; &lt;Analysis/Assess/Total&gt;
#&gt; &lt;7200/800/8000&gt;
#&gt; 
#&gt; [[3]]
#&gt; &lt;Analysis/Assess/Total&gt;
#&gt; &lt;7200/800/8000&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>These separate sets are in a list column, which is a way to store non-atomic types in a dataframe</p>
</div>
</div>
<p><strong>We can do this with how many folds we want</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r vfold-cv-v}</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="in">vfold_cv(taxi_train, v = 5)</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; #  5-fold cross-validation 
#&gt; # A tibble: 5 Ã— 2
#&gt;   splits              id   
#&gt;   &lt;list&gt;              &lt;chr&gt;
#&gt; 1 &lt;split [6400/1600]&gt; Fold1
#&gt; 2 &lt;split [6400/1600]&gt; Fold2
#&gt; 3 &lt;split [6400/1600]&gt; Fold3
#&gt; 4 &lt;split [6400/1600]&gt; Fold4
#&gt; 5 &lt;split [6400/1600]&gt; Fold5</code></pre>
</div>
</div>
<p><strong>Stratification often helps, with very little downside</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r vfold-cv-strata}</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="in">vfold_cv(taxi_train, strata = tip)</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; #  10-fold cross-validation using stratification 
#&gt; # A tibble: 10 Ã— 2
#&gt;    splits             id    
#&gt;    &lt;list&gt;             &lt;chr&gt; 
#&gt;  1 &lt;split [7200/800]&gt; Fold01
#&gt;  2 &lt;split [7200/800]&gt; Fold02
#&gt;  3 &lt;split [7200/800]&gt; Fold03
#&gt;  4 &lt;split [7200/800]&gt; Fold04
#&gt;  5 &lt;split [7200/800]&gt; Fold05
#&gt;  6 &lt;split [7200/800]&gt; Fold06
#&gt;  7 &lt;split [7200/800]&gt; Fold07
#&gt;  8 &lt;split [7200/800]&gt; Fold08
#&gt;  9 &lt;split [7200/800]&gt; Fold09
#&gt; 10 &lt;split [7200/800]&gt; Fold10</code></pre>
</div>
</div>
<section id="well-use-this-setup" class="level3">
<h3 class="anchored" data-anchor-id="well-use-this-setup">Weâ€™ll use this setup:</h3>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Set the seed when creating resamples</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r taxi-folds}</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(123)</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_folds &lt;- vfold_cv(taxi_train, v = 10, strata = tip)</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_folds</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; #  10-fold cross-validation using stratification 
#&gt; # A tibble: 10 Ã— 2
#&gt;    splits             id    
#&gt;    &lt;list&gt;             &lt;chr&gt; 
#&gt;  1 &lt;split [7200/800]&gt; Fold01
#&gt;  2 &lt;split [7200/800]&gt; Fold02
#&gt;  3 &lt;split [7200/800]&gt; Fold03
#&gt;  4 &lt;split [7200/800]&gt; Fold04
#&gt;  5 &lt;split [7200/800]&gt; Fold05
#&gt;  6 &lt;split [7200/800]&gt; Fold06
#&gt;  7 &lt;split [7200/800]&gt; Fold07
#&gt;  8 &lt;split [7200/800]&gt; Fold08
#&gt;  9 &lt;split [7200/800]&gt; Fold09
#&gt; 10 &lt;split [7200/800]&gt; Fold10</code></pre>
</div>
</div>
</section>
</section>
<section id="fit-our-model-to-the-resamples" class="level2">
<h2 class="anchored" data-anchor-id="fit-our-model-to-the-resamples">Fit our model to the resamples!</h2>
<p>We will fit 10 models on 10 slightly different analysis sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fit-resamples}</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_res &lt;- fit_resamples(tree_wflow, taxi_folds)</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_res</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # Resampling results
#&gt; # 10-fold cross-validation using stratification 
#&gt; # A tibble: 10 Ã— 4
#&gt;    splits             id     .metrics         .notes          
#&gt;    &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;          
#&gt;  1 &lt;split [7200/800]&gt; Fold01 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  2 &lt;split [7200/800]&gt; Fold02 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  3 &lt;split [7200/800]&gt; Fold03 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  4 &lt;split [7200/800]&gt; Fold04 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  5 &lt;split [7200/800]&gt; Fold05 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  6 &lt;split [7200/800]&gt; Fold06 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  7 &lt;split [7200/800]&gt; Fold07 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  8 &lt;split [7200/800]&gt; Fold08 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt;  9 &lt;split [7200/800]&gt; Fold09 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;
#&gt; 10 &lt;split [7200/800]&gt; Fold10 &lt;tibble [3 Ã— 4]&gt; &lt;tibble [0 Ã— 3]&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Alternate resampling schemes
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="hexes/rsample.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
<section id="bootstrapping" class="level2">
<h2 class="anchored" data-anchor-id="bootstrapping">Bootstrapping</h2>
<ul>
<li><p>Assess model accuracy and stability</p></li>
<li><p>From your original training dataset, create many (often thousands) of new â€œbootstrapâ€ training datasets by sampling with replacement.</p></li>
</ul>
<p><img src="https://www.tmwr.org/premade/bootstraps.svg" class="img-fluid"></p>
<ul>
<li>After running the bootstrap process many times, youâ€™ll end up with a distribution of performance metrics (like accuracy or AUC).</li>
</ul>
<p><strong>Handling Small Datasets:</strong> It is particularly useful when dealing with small datasets where you might not be able to afford to set aside a portion of the data as a test set.</p>
<p><strong>Uncertainty Estimates:</strong> It provides a way to create confidence intervals for various performance metrics, giving a sense of how uncertain those metrics are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bootstraps}</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(3214)</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="in">bootstraps(taxi_train)</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # Bootstrap sampling 
#&gt; # A tibble: 25 Ã— 2
#&gt;    splits              id         
#&gt;    &lt;list&gt;              &lt;chr&gt;      
#&gt;  1 &lt;split [8000/2902]&gt; Bootstrap01
#&gt;  2 &lt;split [8000/2916]&gt; Bootstrap02
#&gt;  3 &lt;split [8000/3004]&gt; Bootstrap03
#&gt;  4 &lt;split [8000/2979]&gt; Bootstrap04
#&gt;  5 &lt;split [8000/2961]&gt; Bootstrap05
#&gt;  6 &lt;split [8000/2962]&gt; Bootstrap06
#&gt;  7 &lt;split [8000/3026]&gt; Bootstrap07
#&gt;  8 &lt;split [8000/2926]&gt; Bootstrap08
#&gt;  9 &lt;split [8000/2972]&gt; Bootstrap09
#&gt; 10 &lt;split [8000/2972]&gt; Bootstrap10
#&gt; # â„¹ 15 more rows</code></pre>
</div>
</div>
<p><a href="https://rsample.tidymodels.org/reference/index.html" class="uri">https://rsample.tidymodels.org/reference/index.html</a></p>
</section>
</div>
</div>
</section>
<section id="your-turn-11" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-11">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="now-run-vfold_cv-to-get-10-splits-and-refit-your-logistic-regression-workflow-using-fit_resamples" class="anchored"><em>Now run <code>vfold_cv</code> to get 10 splits and refit your logistic regression workflow (using <code>fit_resamples</code>)</em></h3></li>
</ul>
<p><img src="hexes/tune.png" class="absolute" data-top="-20" data-right="0" width="64" height="74"></p>
</section>
<section id="evaluating-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-model-performance">Evaluating model performance</h2>
<ul>
<li>The goal of resampling is to produce a single estimate of performance for a model</li>
<li>The final performance is based on the hold-out predictions by averaging the statistics from the V folds.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Even though we end up estimating V models, these models are discarded after we have our performance estimate. ğŸ—‘</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r collect-metrics}</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_res %&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics()</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 3 Ã— 6
#&gt;   .metric     .estimator   mean     n std_err .config             
#&gt;   &lt;chr&gt;       &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
#&gt; 1 accuracy    binary     0.923     10 0.00320 Preprocessor1_Model1
#&gt; 2 brier_class binary     0.0699    10 0.00262 Preprocessor1_Model1
#&gt; 3 roc_auc     binary     0.592     10 0.0126  Preprocessor1_Model1</code></pre>
</div>
</div>
<section id="we-can-reliably-measure-performance-using-only-the-training-data" class="level3">
<h3 class="anchored" data-anchor-id="we-can-reliably-measure-performance-using-only-the-training-data">We can reliably measure performance using only the <strong>training</strong> data ğŸ‰</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>collect_metrics()</code> is one of a suite of <code>collect_*()</code> functions that can be used to work with columns of tuning results. Most columns in a tuning result prefixed with <code>.</code> have a corresponding <code>collect_*()</code> function with options for common summaries.</p>
</div>
</div>
<!--```{r}
library(shinymodels)
explore(taxi_res, 
        hover_cols = c(tip))
```
-->
</section>
</section>
<section id="your-turn-12" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-12">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="use-collect_metrics-to-get-a-single-estimates-of-performance-on-your-cross-validated-logistic-regression" class="anchored"><em>Use <code>collect_metrics()</code> to get a single estimates of performance on your cross-validated logistic regression</em></h3></li>
<li><h3 id="generate-a-new-confusion-matrix-for-your-cross-validated-logistic-regression" class="anchored"><em>Generate a new confusion matrix for your cross-validated logistic regression</em></h3></li>
</ul>
<section id="does-our-model-perfomance-change-when-fit-once-on-the-training-data-vs-resampling-on-the-training-data" class="level3">
<h3 class="anchored" data-anchor-id="does-our-model-perfomance-change-when-fit-once-on-the-training-data-vs-resampling-on-the-training-data">Does our model perfomance change when fit once on the training data vs resampling on the training data?</h3>
<p><strong>Do you remember this from way back when? This is the ROC AUC from no resampling:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r roc-auc-2}</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_train) %&gt;% </span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_auc(truth = tip, .pred_yes)</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.611</code></pre>
</div>
</div>
<p><strong>Now, this is from resampling:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_res %&gt;%</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="in">  collect_metrics() %&gt;% </span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="in">  select(.metric, mean, n)</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 3 Ã— 3
#&gt;   .metric       mean     n
#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;int&gt;
#&gt; 1 accuracy    0.923     10
#&gt; 2 brier_class 0.0699    10
#&gt; 3 roc_auc     0.592     10</code></pre>
</div>
</div>
<section id="lesson-is-that-the-fitting-a-model-on-just-the-training-set-without-resampling-gives-you-overly-optimistic-metrics" class="level4">
<h4 class="anchored" data-anchor-id="lesson-is-that-the-fitting-a-model-on-just-the-training-set-without-resampling-gives-you-overly-optimistic-metrics">Lesson is that the fitting a model on just the training set (without resampling) gives you overly optimistic metrics âš ï¸</h4>
</section>
</section>
</section>
<section id="what-you-would-report" class="level2">
<h2 class="anchored" data-anchor-id="what-you-would-report">What you would report</h2>
<ul>
<li><strong>Training Performance (Cross-Validation):</strong>
<ul>
<li>Present metrics that summarize the modelâ€™s performance across the folds
<ul>
<li>mean and standard deviation of accuracy</li>
<li>AUC</li>
<li>sensitivity</li>
<li>specificity</li>
</ul></li>
</ul></li>
</ul>
<p>This gives an indication of how well the model is expected to perform on unseen data, taking into account the variability due to different subsets of the training data.</p>
<ul>
<li><strong>Test Set Performance:</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="in">taxi_metrics &lt;- metric_set(accuracy, specificity, sensitivity)</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_test) %&gt;%</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="in">  taxi_metrics(truth = tip, estimate = .pred_class)</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 3 Ã— 3
#&gt;   .metric     .estimator .estimate
#&gt;   &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 accuracy    binary        0.914 
#&gt; 2 specificity binary        0.0457
#&gt; 3 sensitivity binary        0.997</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="in">augment(tree_fit, new_data = taxi_test) %&gt;% </span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_auc(truth = tip, .pred_yes)</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 Ã— 3
#&gt;   .metric .estimator .estimate
#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
#&gt; 1 roc_auc binary         0.602</code></pre>
</div>
</div>
<p>The performance metrics derived from the held-out test set give the reader an understanding of how the model performs on completely unseen data. This is the ultimate test of the modelâ€™s generalizability and is often considered the most important set of metrics to report.</p>
<ul>
<li><strong>Overfitting Discussion</strong></li>
</ul>
<p>Discuss any signs of overfitting observed (for instance, if there was a large discrepancy between the cross-validation performance and the test set performance).</p>
<ul>
<li><strong>Model Interpretability</strong></li>
</ul>
<p>Itâ€™s often important to discuss what the modelâ€™s parameters or predictions mean in the context of the subject area.</p>
</section>
<section id="your-turn-13" class="level2">
<h2 class="anchored" data-anchor-id="your-turn-13">Your turn</h2>
<p><img src="img/parsnip-flagger.jpg" class="absolute" data-top="0" data-right="0" width="150" height="150"></p>
<ul>
<li><h3 id="generate-a-final-report-for-your-regression-logistic-model-but-now-using-the-test-set" class="anchored"><em>Generate a final report for your regression logistic model, but now using the test set</em></h3></li>
</ul>
</section>
<section id="completing-the-whole-game" class="level2">
<h2 class="anchored" data-anchor-id="completing-the-whole-game">Completing the whole game</h2>
<p><img src="img/whole-game-final-performance.jpg" class="img-fluid"></p>
</section>
</section>
<section id="part-6-next-steps" class="level1">
<h1>PART 6: Next Steps?</h1>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">Random forest ğŸŒ³ğŸŒ²ğŸŒ´ğŸŒµğŸŒ³ğŸŒ³ğŸŒ´ğŸŒ²ğŸŒµğŸŒ´ğŸŒ³ğŸŒµ</h2>
<ul>
<li>Ensemble many decision tree models
<ul>
<li>All the trees vote! ğŸ—³ï¸</li>
<li>Bootstrap aggregating + random predictor sampling</li>
</ul></li>
</ul>
</section>
<section id="model-tuning" class="level2">
<h2 class="anchored" data-anchor-id="model-tuning">Model tuning</h2>
<ul>
<li>Requires tuning model parameters with more advanced machine learning methods
<ul>
<li>Growing phase; tree pruning
<ul>
<li>Grid search</li>
<li>Iterative search</li>
</ul></li>
<li>Nice resource: <a href="https://topepo.github.io/2022-nyr-workshop/5-tuning.html#1" class="uri">https://topepo.github.io/2022-nyr-workshop/5-tuning.html#1</a></li>
</ul></li>
</ul>
</section>
<section id="variable-importance" class="level2">
<h2 class="anchored" data-anchor-id="variable-importance">Variable importance</h2>
<ul>
<li><code>vip</code> package</li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>